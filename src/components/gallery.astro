---
// Images
import { Image } from 'astro:assets'
const images = await Astro.glob('/src/assets/gallery/*.{jpg,png}').then((files) => {
	return files.map((file) => file.default)
})

// Add Videos
const videos = [
	{
		position: 1,
		url: 'https://vimeo.com/987618755',
		id: '987618755',
		width: 856,
		height: 1080
	},
	{
		position: 5,
		url: 'https://vimeo.com/987638197',
		id: '987638197',
		width: 1080,
		height: 1080
	},
	{
		position: 7,
		url: 'https://vimeo.com/987658015',
		id: '987658015',
		width: 856,
		height: 1080
	},
	{
		position: 12,
		url: 'https://vimeo.com/987945568',
		id: '987945568',
		width: 1080,
		height: 1645
	}
]

// Merge images + videos
let x
for (x = 0; x < images.length + 1; x++) {
	videos.forEach((video) => {
		if (video.position === x + 1) {
			images.splice(x, 0, {
				url: video.url,
				format: 'video',
				id: video.id,
				width: video.width,
				height: video.height
			})
		}
	})
}

const numberOfColumns = 3
const imagesArray = await Promise.all(images)
const imagesPerColumn = Math.ceil(imagesArray.length / numberOfColumns)
let imageColumns = []
let imageIndex = 0

for (let x = 0; x < numberOfColumns; x++) {
	imageColumns.push(imagesArray.slice(imageIndex, imageIndex + imagesPerColumn))
	imageIndex += imagesPerColumn
}
---

<section>
	<div class="page-width row-top-x2 row-bottom-x2">
		<div class="title-container text-line-reversed row-bottom-x2">
			<h2 class="text-white text-center"><span class="text-background">Gallery Section</span></h2>
		</div>
		<div class="gallery-container">
			{
				imageColumns.map((column) => (
					<div class="gallery-column">
						{column.map((img, i) => (
							<div class="gallery-item">
								{img.format !== 'video' ? (
									<Image
										src={img}
										alt=""
										widths={[640, 490, 980]}
										sizes={'(max-width: 640px) 640px, (max-width: 980px) 490px, 980px'}
										format="webp"
										quality={80}
										loading={i > 3 ? 'lazy' : 'eager'}
										class="gallery-image"
									/>
								) : (
									<div
										class="video-container"
										style={`padding-bottom: calc(${img.height} / ${img.width} * 100%)`}
									>
										<iframe
											id={`vimeo-player=${img.id}`}
											class="vimeo-player"
											width={`${img.width}`}
											height={`${img.height}`}
											src={`
												https://player.vimeo.com/video/${img.id}?autoplay=1&muted=1&controls=0&loop=1&background=1
												`}
											allow="autoplay; fullscreen"
											allowfullscreen
										/>
										<script />
									</div>
								)}
							</div>
						))}
					</div>
				))
			}
		</div>
	</div>
</section>

<style>
	section {
		min-height: 100vh;
		background-color: #000;
	}
	.gallery-container {
		display: flex;
		gap: 1rem;
		justify-content: center;
	}
	.gallery-column {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.gallery-image {
		width: 100%;
		height: auto;
		display: block;
	}
	.video-container {
		text-align: center;
		position: relative;
		width: 100%;
		padding-bottom: calc(9 / 16 * 100%); /* Aspect 16:9 */
		height: 0;
		overflow: hidden;
	}

	iframe {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		object-fit: cover;
		border: none;
	}

	@media (max-width: 640px) {
		.gallery-container {
			flex-direction: column;
		}
	}
</style>
